# Docker Logs Management

Docker is an operating system-level virtualization platform that allows us to host applications in containers. Furthermore, it facilitates the separation of applications and infrastructure for fast software delivery.

Log files generated by Docker containers contain a variety of useful information. Whenever an event occurs, the Docker container creates log files.

Docker generates the logs to the ```STDOUT``` or ```STDERR```, including log origin, output stream data, and timestamp. Debugging and finding the root cause of problems can be done using log files.


## Docker logs

In Docker, primarily, there are two types of log files. The Docker daemon logs provide insight into the Docker service’s overall status. The Docker container logs cover all the logs related to a particular container.

We’ll primarily explore the different commands to access the Docker container logs. We’ll examine the container logs using the docker logs command and by directly accessing the logs file on the system.

The log files are useful to debug problems because they provide details about what occurred. By analyzing Docker logs, we can diagnose and troubleshoot issues faster.


### Using the "docker logs" Command

- Run simple nginx container

```
$ docker run --name logs-nginx -d -p 80:80 nginx


Unable to find image 'nginx:latest' locally
latest: Pulling from library/nginx
e1caac4eb9d2: Pull complete 
88f6f236f401: Pull complete 
c3ea3344e711: Pull complete 
cc1bb4345a3a: Pull complete 
da8fa4352481: Pull complete 
c7f80e9cdab2: Pull complete 
18a869624cb6: Pull complete 
Digest: sha256:c26ae7472d624ba1fafd296e73cecc4f93f853088e6a9c13c0d52f6ca5865107
Status: Downloaded newer image for nginx:latest
6b8f33da2e29ee2dcb3d369dae4a9feb2b11708fd96d48a7839016a0bb950505
```

- Check container

```
$ docker ps


CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                               NAMES
6b8f33da2e29   nginx     "/docker-entrypoint.…"   2 minutes ago   Up 2 minutes   0.0.0.0:80->80/tcp, :::80->80/tcp   logs-nginx
```


- You can see the logs of this running nginx container either by image id or by image name

```
$ docker logs 6b8f33da2e29




/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
2024/02/23 12:50:04 [notice] 1#1: using the "epoll" event method
2024/02/23 12:50:04 [notice] 1#1: nginx/1.25.4
2024/02/23 12:50:04 [notice] 1#1: built by gcc 12.2.0 (Debian 12.2.0-14) 
2024/02/23 12:50:04 [notice] 1#1: OS: Linux 5.15.0-1048-aws
2024/02/23 12:50:04 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2024/02/23 12:50:04 [notice] 1#1: start worker processes
2024/02/23 12:50:04 [notice] 1#1: start worker process 29
2024/02/23 12:50:04 [notice] 1#1: start worker process 30
2024/02/23 12:50:04 [notice] 1#1: start worker process 31
2024/02/23 12:50:04 [notice] 1#1: start worker process 32
```


- When looking at the logs we can give the ```--follow``` or ```-f``` parameter to monitor in real time

```
$ docker logs -f logs-nginx



.
.
2024/02/23 12:50:04 [notice] 1#1: start worker process 29
2024/02/23 12:50:04 [notice] 1#1: start worker process 30
2024/02/23 12:50:04 [notice] 1#1: start worker process 31
2024/02/23 12:50:04 [notice] 1#1: start worker process 32
.
.
.
```


- With the --tail parameter, we can look at the last lines of the log output, making our work easier

```
docker logs -f --tail 5 logs-nginx
```


- We can also use the “since” option with the docker log command to view the file from a particular time

```
docker logs --since 2024-02-11 logs-nginx
```

### Default Log File

The Docker stores all the STDOUT and STDERR output in JSON format. Additionally, it is possible to monitor all the live Docker logs from the host machine. By default, Docker stores log files in a dedicated directory on the host using the json-file log driver. The log file directory is /var/lib/docker/containers/<container_id> on the host where the container is running.

```
root@logs:/var/lib/docker/containers/6b8f33da2e29ee2dcb3d369dae4a9feb2b11708fd96d48a7839016a0bb950505/local-logs# ll

total 16
drwx------ 2 root root 4096 Feb 23 12:50 ./
drwx--x--- 5 root root 4096 Feb 23 12:50 ../
-rw-r----- 1 root root 6825 Feb 23 12:56 container.log
```

- if you read the container.logs file here you will get the same output as the docker logs command

```
$ cat container.log

.
.
2024/02/23 12:50:04 [notice] 1#1: start worker process 29
2024/02/23 12:50:04 [notice] 1#1: start worker process 30
2024/02/23 12:50:04 [notice] 1#1: start worker process 31
2024/02/23 12:50:04 [notice] 1#1: start worker process 32
```

## Disk Issue

- If you are using a Micro Service application or if your application is in a constant log state, this may increase the server disk and the disk may fill up.

- This command will reset the logs of all running containers and will not delete the log file completely. it will only empty the file

```
$ truncate -s 0 /var/lib/docker/containers/*/local-logs/*.log
```

- To reset the size of the log file of a specific container, this command is sufficient

```
$ truncate -s 0 /var/lib/docker/containers/container-ID/local-logs/container.log
```

- Or we can reset the file with a different Linux command

```
$ echo "" > /var/lib/docker/containers/container-ID/local-logs/container.log
```

### Clearing the Log File

- At the start of the container, we can also limit the size of a log file externally using the ```"-log-opt max-size"``` and ```"-log-opt max-file"``` options of the docker run command. But we don't recommend this because we should apply the restriction equally to Docker as a process and to all containers in general.

- In ```/etc/docker/daemon.json``` there are several options if we want to apply log restrictions across each container

1. Json-file Driver
```
{
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "1k",
        "max-file": "5" 
    }
}
```

2.  Local Driver
```
{
  "log-driver": "local",
  "log-opts": {
    "max-size": "10m"
  }
}
```

- To accept the changes made

```
$ systemctl restart docker
```

- It is important to transfer the logs of important containers to a file before cleaning the logs or taking any action.

- Redirecting the Docker Container Logs to a Single File

```
$ docker logs logs-nginx > nginx-service.log
```













Official document:
https://docs.docker.com/config/containers/logging/local/


